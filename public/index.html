<!DOCTYPE html>
<body>
	<h1> Log </h1>
	<div id="log">
	</div>
	<div id="choices">
	</div>
	<script>
		var currentLine = 1;

		async function updateLog(event){
			let index = event.data
			if(index <= currentLine) { return }

			let text = await fetch(`/update/log?line=${currentLine}`)
				.then((response) => response.text())
				.then((text) => text)

			if ( text != undefined ) {
				let newLine = document.createElement('p')
				newLine.id = `line ${currentLine}`
				newLine.innerText = text.trimEnd()

				document.getElementById("log").append(newLine)

				currentLine += 1
			}
		};

		async function updateChoices(event){
			let index = event.data
			let list = await fetch('/update/choices')
				.then((response) => response.json())
				.then((json) => json)

			if ( choices != undefined ) {
				let choiceList = document.getElementById("choices")
				let newChoices = []
				for ( choice of list ) {
					let newChoice = document.createElement('button')
					newChoice.innerText = choice.text

					newChoice.name = "index"
					newChoice.value = choice.index
					newChoice.type = "submit"

					newChoice.onclick = (event) => {
								fetch(`/choose?index=${choice.index}`, {method: "post"}).await
					}
					newChoices.push(newChoice)
				}

				if ( newChoices.length === 0 ){
					let contButton = document.createElement('button')
					contButton.innerText = "continue.."
					contButton.onclick = updateLog

					newChoices.push(contButton)
				}

				choiceList.replaceChildren(...newChoices)
			}
		};

		const evnt = new EventSource('/stream')
		evnt.addEventListener('New content', updateLog)
		evnt.addEventListener('New content', updateChoices)
		evnt.addEventListener('New choices', updateChoices)

		window.onload = updateLog
	</script>
</body>
